var app=angular.module("MyApp.services",["ngStorage"]);app.factory("UserData",function(){}),app.factory("parseFactory",["$rootScope","$localStorage","$timeout","$ionicHistory","$state",function(e,a,t,n,r){return{register:function(a){var t=this,n=new Parse.User;n.set("username",a.email),n.set("password",a.password),n.set("email",a.email),e.$storage.mainObj.username=a.email,n.signUp(null,{success:function(n){e.$storage.mainObj.username=a.email,e.$storage.mainObj.email=a.email,e.$storage.mainObj.registered=!0,alert("Registration successful"),e.$broadcast("cloud-load"),t.deleteAndSave()},error:function(e,a){console.log(a),125==a.code&&alert("Error, invalid email address"),alert(202==a.code?"Error, username is taken! Already an account w/ this email":"Error signing up, make sure email is valid")}})},logIn:function(a){var t=this;e.$storage.mainObj.username=a.email,e.$storage.mainObj.email=a.email,console.log("logging in"),Parse.User.logIn(a.email,a.password,{success:function(e){t.loadFrom(a.email)},error:function(e,a){alert("Error: No connection or invalid username/password")}})},saveNew:function(){if(e.$storage.mainObj.unlocked&&e.$storage.mainObj.registered&&e.$storage.mainObj.username.length>1){var a=JSON.stringify(e.$storage.mainObj),t=Parse.Object.extend("Backup"),n=new t;n.set("username",e.$storage.mainObj.username),n.set("file",a),n.save(null,{success:function(e){},error:function(e,a){}})}},deleteAndSave:function(){var a=this,t=new Parse.Query("Backup");console.log("delSave",e.$storage.mainObj.unlocked,e.$storage.mainObj.registered,e.$storage.mainObj.username.length>1),e.$storage.mainObj.unlocked&&e.$storage.mainObj.registered&&e.$storage.mainObj.username.length>1&&(t.equalTo("username",e.$storage.mainObj.username),t.find({success:function(e){for(var t=0;t<e.length;t++)e[t].destroy({});a.saveNew()},error:function(e){}}))},loadFrom:function(a){var n=new Parse.Query("Backup");n.equalTo("username",a),n.find({success:function(a){console.log("result",a[0].get("file")),console.log("parse",JSON.parse(a[0].get("file"))),e.$storage.mainObj=JSON.parse(a[0].get("file")),e.$broadcast("cloud-load"),t(function(){r.go("tab.calendar"),e.$broadcast("cloud-load"),r.go("tab.posts"),e.$broadcast("cloud-load")},30),e.$storage.mainObj.justLoaded=!0,e.$storage.mainObj.registered=!0},error:function(e){}})},checkPromo:function(a){var t=new Parse.Query("Promo");t.equalTo("code",a),t.find({success:function(a){if("undefined"!=typeof a[0]){var t=a[0].get("valid");console.log("valid",t),e.$broadcast("promo-return",a[0].get("valid"))}else e.$broadcast("promo-return",!1)},error:function(e){alert("Error contacting server, try again later")}})},getIt:function(){var a=new Parse.Query("ActiveP");a.equalTo("active","active"),a.find({success:function(a){if("undefined"!=typeof a[0]){{a[0].get("shown")}console.log("error active1"),e.$broadcast("active-return",a[0].get("shown"))}else e.$broadcast("active-return",!1)},error:function(e){console.log("error active",e)}})}}}]),app.factory("QuickActionService",["$rootScope","$localStorage","$q","$ionicHistory","$state",function(e,a,t,n,r){var o=function(){return t(function(e,a){window.ThreeDeeTouch?window.ThreeDeeTouch.isAvailable(function(a){e(a)}):a()})},i=function(){o().then(function(a){a&&(window.ThreeDeeTouch.configureQuickActions([{type:"tab.posts",title:"New Workout",subtitle:""},{type:"tab.calendar",title:"Calendar",subtitle:""},{type:"tab.charts",title:"Chart",subtitle:""},{type:"tab.timer",title:"Timer",subtitle:""}]),window.ThreeDeeTouch.onHomeIconPressed=function(a){e.$broadcast("tab-quick",a)})})};return{configure:i}}]),app.factory("localStore",["$rootScope","$localStorage","$timeout","parseFactory",function(e,a,t,n){var r=function(e){var a=new Date(e);a.setHours(0,0,0,0),a.setDate(a.getDate()+3-(a.getDay()+6)%7);var t=new Date(a.getFullYear(),0,4);return 1+Math.round(((a.getTime()-t.getTime())/864e5-3+(t.getDay()+6)%7)/7)},o=function(){e.$broadcast("clear-cal"),e.clearCal=!0};return{addLift:function(a,t,n){console.log("ad ddeep"),e.$storage.mainObj.todaysLifts.push({name:a,sets:t,"super":n}),console.log("ad ddeep1",e.$storage.mainObj.todaysLifts)},saveLift:function(a,t,r,o,i){e.$storage.mainObj.workouts.unshift({date:a,name:r.name,bodyWeight:o.wt,lifts:t,notes:i.notes}),e.$storage.mainObj.nameList[r.name+a]=r.name,angular.forEach(t,function(a,t){e.$storage.mainObj.liftMap[a.name]?e.$storage.mainObj.liftMap[a.name]++:e.$storage.mainObj.liftMap[a.name]=1}),console.log("added"),e.$storage.mainObj.todaysLifts=[{name:"Select Lift",sets:[{reps:"0",wt:"0"}],"super":!1}],e.$broadcast("calRefresh"),e.$storage.mainObj.liftCount++,n.deleteAndSave()},removeWorkout:function(a){console.log(a,e.$storage.mainObj.workouts),angular.forEach(e.$storage.mainObj.workouts,function(t,n){a.date==t.date&&e.$storage.mainObj.workouts.splice(n,1)}),angular.forEach(e.$storage.mainObj.nameList,function(t,n){console.log("name",t,"key",n,"targetttt",a.name+a.date),delete e.$storage.mainObj.nameList[a.name+a.date]}),e.$storage.mainObj.cleared&&e.$storage.mainObj.liftCount--,n.deleteAndSave()},checkDay:function(a){var t=!1;return angular.forEach(e.$storage.mainObj.workouts,function(e,n){var r=Number(e.date.slice(3,6)),o=Number(a);r==o&&(t=!0)}),t},checkDate:function(a){var t=!1;return angular.forEach(e.$storage.mainObj.workouts,function(e,n){e.date==a&&(t=!0)}),t},clearLifts:function(){e.$storage.mainObj.todaysLifts=[{name:"Select Lift",sets:[{reps:"0",wt:"0"}]}]},clearAll:function(){a.$reset(),e.$storage.mainObj.todaysLifts=[{name:"Select Lift",sets:[{reps:"0",wt:"0"}]}],e.$storage.mainObj.populated=!0,e.$storage.mainObj.firstVisit=!1,e.$storage.mainObj.liftCount=0,location.reload(),o()},clearLiftsOnly:function(){e.$storage.mainObj.workouts=[],e.$storage.mainObj.nameList={},e.$storage.mainObj.todaysLifts=[{name:"Select Lift",sets:[{reps:"0",wt:"0"}]}],e.$storage.mainObj.liftMap={},e.$storage.mainObj.liftCount=0,o()},addSet:function(a){if(e.$storage.mainObj.todaysLifts[a].sets.length<10){var t=angular.copy(_.last(e.$storage.mainObj.todaysLifts[a].sets));e.$storage.mainObj.todaysLifts[a].sets.push(t)}},removeSet:function(a){e.$storage.mainObj.todaysLifts[a].sets.length>1&&e.$storage.mainObj.todaysLifts[a].sets.splice(-1,1)},buildKgMap:function(){e.$storage.mainObj.kgMap={},angular.forEach(e.$storage.mainObj.liftData,function(a,t){e.$storage.mainObj.kgMap[a.name]="heavykg"==a.weight?"kgs":"lbs",console.log(e.$storage.mainObj.kgMap)});var a=angular.copy(e.$storage.mainObj.kgMap);return console.log("map",a),a},getChartData:function(a,t,n){var r=[],o=[],i=[],s={};if(angular.forEach(e.$storage.mainObj.workouts,function(e,n){angular.forEach(e.lifts,function(n,u){n.name==a&&angular.forEach(n.sets,function(a,u){if(Number(a.reps)==Number(t))if(s[String(n.name)+String(a.reps)+String(e.date)]>0){var c=Number(s[String(n.name)+String(a.reps)+String(e.date)]);c<a.wt&&(r.pop(),i.pop(),r.push(Number(a.wt)),i.push({wt:Number(a.wt),date:e.date}))}else s[String(n.name)+String(a.reps)+String(e.date)]=Number(a.wt),r.push(Number(a.wt)),o.push(e.date),i.push({wt:Number(a.wt),date:e.date})})})}),1==n){0==r.length&&(r=[0]);var u=[r];return u}return 2==n?(0==o.length&&(o=["","No Data Available"]),o):i},removeLiftEntry:function(a){angular.forEach(e.$storage.mainObj.liftData,function(t,n){t.name==a&&e.$storage.mainObj.liftData.splice(n,1)})},addLiftToList:function(a){e.$storage.mainObj.liftData.unshift({name:a,attr1:".",attr2:".",attr3:".",custom:!0,weight:"heavy"}),n.deleteAndSave()},getLiftByName:function(a){var t={};return angular.forEach(e.$storage.mainObj.liftData,function(e,n){a==e.name&&(t=e)}),t},loadLiftFromCalendar:function(a){angular.forEach(e.$storage.mainObj.workouts,function(t,n){console.log("name",a.name,a.date),a.name==t.name&&a.date==t.date&&(e.$storage.mainObj.todaysLifts=angular.copy(t.lifts))}),console.log("name",a.name),a.name&&(console.log("adding name"),e.$storage.mainObj.tabTitle=a.name)},wipeWeights:function(){angular.forEach(e.$storage.mainObj.todaysLifts,function(e,a){angular.forEach(e.sets,function(e,a){e.wt=0})}),e.$broadcast("loadedFromCalendar")},liftsOnly:function(){angular.forEach(e.$storage.mainObj.todaysLifts,function(e,a){e.sets=[{reps:"0",wt:"0"}]}),e.$broadcast("loadedFromCalendar")},makeCalendar:function(){return{$storage:a,workouts:$storage.mainObj.workouts,filterList:angular.copy($storage.mainObj.workouts),searchQuery:"",dateType:"",today:new Date,dateObj:{Year:"Year",Month:"Month",Day:"Day"},$storage:a,nameList:$storage.mainObj.nameList,nameFilter:"Name",liftName:"Lift",monthMap:{Jan:1,Feb:2,Mar:3,Apr:4,May:5,Jun:6,Jul:7,Aug:8,Sep:9,Oct:10,Nov:11,Dec:12},calendar1:!0,infoFlag:2}},buildRepList:function(a){var t=[];angular.forEach(e.$storage.mainObj.workouts,function(e,n){angular.forEach(e.lifts,function(e,n){e.name==a&&angular.forEach(e.sets,function(e,a){t.push(Number(e.reps))})})});var n=_.unique(t),r=n.sort(function(e,a){return e-a}),o=[];return angular.forEach(r,function(e,a){o.push({reps:Number(e)})}),void 0==o[0]&&(o=[{reps:0}]),o},getBodyWeightData:function(a){var t=[],n=[];if(angular.forEach(e.$storage.mainObj.workouts,function(e,a){e.bodyWeight&&(t.push(e.bodyWeight),n.push(e.date))}),1==a){0==t.length&&(t=[0]);var r=[t];return r}return 0==n.length&&(n=["","No Data Available"]),n},getMax:function(a,t){var n=[],r=[];angular.forEach(e.$storage.mainObj.workouts,function(e,o){r.push({wt:e.bodyWeight,date:e.date}),angular.forEach(e.lifts,function(r,i){if(o>0&&r.name==a){var s=[];angular.forEach(r.sets,function(a,n){Number(a.reps)==Number(t)&&(console.log("reps",t),s.push({wt:Number(a.wt),date:e.date}))});var u=_.max(s,function(e){return e.wt});n.push(u)}})});var o=_.max(n,function(e){return e.wt});return 1==n.length&&(o.only1=!0),"Body Weight"==a&&(o=r),o},updateGoals:function(a){angular.forEach(a,function(a,t){console.log("inserted goal for:",t),e.$storage.mainObj.goalsMap[t]=a,console.log(e.$storage.mainObj.goalsMap)})},getGoal:function(a){return e.$storage.mainObj.goalsMap[a]},setStartTime:function(a,t){e.$storage.mainObj.startTime=+new Date,console.log("timetrace",e.$storage.mainObj.startTime,a,t),e.$storage.mainObj.min=a,e.$storage.mainObj.sec=t,console.log("timetrace2",e.$storage.mainObj.startTime,e.$storage.mainObj.min,e.$storage.mainObj.sec)},getStartTime:function(){return e.$storage.mainObj.startTime},getStartMinSec:function(){return console.log("starttime return",{min:e.$storage.mainObj.min,sec:e.$storage.mainObj.sec}),{min:angular.copy(e.$storage.mainObj.min),sec:angular.copy(e.$storage.mainObj.sec)}},resetStartTime:function(){e.$storage.mainObj.startTime=0,e.$storage.mainObj.min=0,e.$storage.mainObj.sec=0},setSelectedCycle:function(a){e.$storage.mainObj.selectedCycle=a},getSelectedCycle:function(a){return e.$storage.mainObj.selectedCycle},getMillisecondsFromMinSec:function(){var a=e.$storage.mainObj.min,t=e.$storage.mainObj.sec,n=60*a*1e3+1e3*t;return n},normalizeToWeeks:function(e,a){var t="none",n=[],o=[],i=e,s=r(i[0].date);t=s;var u=r(i[0].date),c=r(i[i.length-1].date),l=c-u,g=new Date(e[0].date),m=new Date(i[i.length-1].date);if(g.getFullYear()!=m.getFullYear()&&53!=c){var f=m.getFullYear()-g.getFullYear();c+=52*f,l=c-u}var d={},b={};angular.forEach(i,function(e,a){var t=r(e.date)-u,n=new Date(e.date);if(n.getFullYear()!=g.getFullYear()&&53!=t&&(t+=52*(n.getFullYear()-g.getFullYear())),b[t]){var o=_.max([Number(b[t].wt),Number(e.wt)]);d[t]={date:e.date,wt:o},b[t]={date:e,wt:o}}else b[t]=e,d[t]=e});for(var $,p=[],O=[],j=[],h=0,w=[],v=0;l+1>v;v++)p[v]=String(v),d[v]&&d[v].hasOwnProperty("wt")?(j[v]=Number(d[v].wt),w[v]=d[v].date,p[v]=String(v),h=d[v].wt,$=new Date(d[v].date)):j[v]=Number(h);O[0]=j;var n=p,o=[j];return 1==a?o:2==a?n:w}}}]);