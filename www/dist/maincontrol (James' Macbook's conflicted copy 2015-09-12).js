var app=angular.module("MyApp.maincontrol",["ionic","MyApp.services","ngStorage","ngCordova"]);app.controller("liftcontrol",["$scope","$ionicModal","$localStorage","$rootScope","$state","localStore","$ionicPopup","$ionicPopover","$ionicPlatform","$timeout","$ionicScrollDelegate","$ionicDeploy",function(e,t,a,o,i,n,s,r,l,u,d,c){e.removeFlag=!1,e.blurFlag=!1,e.indexLift=0,e.userId="userX",e.focusIndex=0,e.date=new Date,e.liftDate=String(e.date).substring(4,15),e.workoutName={name:""},e.bodyWeight={wt:""},e.maxList={},e.lastList={};var f={},p={};e.todaysMaxs={},e.lastClickedRep={},e.goalMap=e.$storage.goalsMap,e.unpackedGoalsMap={},e.$storage=a,e.rangeMap={},e.rangeFlipFlag=!0,e.editingShow=0,e.lightHeavyMap=e.$storage.lightHeavyMap,e.nameList=e.$storage.nameList;var m=0,g=0,h=0;e.uniqueNameSetsMap={},e.resultsSourceNameMap={},e.resultsSource=[],e.notes={notes:""};var b=new Date;e.dateObj={Year:b.getFullYear(),Month:[b.getMonth()],Day:b.getDate()},e.dateList=[],e.calendar1=!1,e.infoFlag=1,e.tabTitle=e.$storage.tabTitle;var w={newlift:"",sets:"",id:""};e.auto={sets:0,reps:0},e.autoSetChoice=[{set1:3},{set1:4},{set1:5},{set1:6}],e.autoRepChoice=[3,5,6,8,10],e.liftCards=e.$storage.todaysLifts,e.updated=e.$storage.updated,l.ready(function(){if(window.cordova){var t=navigator.connection.type;if(o.checkAndDoUpdate(t),e.$storage.updated){e.$storage.updated=!1;var a=s.show({title:"Gain Updated",subTitle:"Changes:Minor bug fixes and enhancements",scope:e,buttons:[{text:"<b>Ok</b>",type:"button-dark"}]});a.then(function(e){})}}}),r.fromTemplateUrl("pop/pop-date.html",{scope:e}).then(function(t){e.popover2=t}),e.closeKeyboard=function(){document.activeElement.blur(),document.activeElement.blur()},e.datePopup=function(t,a){if(document.body.classList.add("platform-ios"),e.dateType=a,"Day"==a){for(var o=[],i=1;31>=i;i++)o.push(i);e.dateList=o}else"Month"==a?e.dateList=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]:"Year"==a&&(e.dateList=["2015","2016","2017","2018","2019","2020"]);e.popover2.show(t)},e.addLift=function(e){n.addLift("Select Lift",[{reps:"0",wt:"0"}],e),d.$getByHandle("small").scrollBottom()},e.$on("loadedFromCalendar",function(t,a){e.liftCards=e.$storage.todaysLifts}),e.removeLift=function(){e.liftCards.length>1&&(e.removeFlag=!e.removeFlag)},e.uniqueSortReps=function(){e.sets=e.resultsLifts;var t=[];angular.forEach(e.resultsLifts,function(e,a){var o=[];angular.forEach(e.sets,function(e,t){o.push(e.reps)}),t.push(o)});var a=[];angular.forEach(t,function(e,t){var o=_.unique(e),i=o.sort(function(e,t){return e-t});a.push(i)}),e.uniqueSortedReps=a},e.populateBodyWeightResults=function(){var t=Number(e.bodyWeight.wt);if(t&&t>10){{var a=n.getMax("Body Weight",0);Math.abs(t)-_.max(a,function(e){return e.wt}).wt,Math.abs(t)-a.slice(-1)[0].wt}return e.maxList["Body Weight"]=Math.abs(Math.abs(t)-_.max(a,function(e){return e.wt}).wt),e.lastList["Body Weight"]=Math.abs(Math.abs(t)-a.slice(-1)[0].wt),{name:"Body Weight",reps:0,todaysMax:e.bodyWeight.wt,max:_.max(a,function(e){return e.wt}).wt,last:a.reverse().slice(-2)[0].wt}}e.maxList["Body Weight"]="None",e.lastList["Body Weight"]="None"},e.buildResultsObject=function(){var t=[];e.uniqueNameSetsMap={},angular.forEach(e.resultsLifts,function(a,o){var i=_.uniq(a.sets,function(e){return e.reps});e.uniqueNameSetsMap[a.name]=i,angular.forEach(i,function(o,i){t.push(e.populateResults(a.name,o.reps))})}),e.resultsSource=t,angular.forEach(e.resultsSource,function(t,a){e.resultsSourceNameMap[t.name+String(t.reps)]=t}),e.resultsSourceNameMap["Body Weight"]=e.populateBodyWeightResults()},e.populateResults=function(t,a,o){var i=[],s=[];e.lastClickedRep[t]=a,angular.forEach(e.resultsLifts,function(e,o){e.name==t&&angular.forEach(e.sets,function(t,o){Number(t.reps)==Number(a)&&(s.push({name:e.name,wt:Number(t.wt)}),i.push(Number(t.wt)))})});var r=_.max(s,function(e){return e.wt});e.todaysMaxs[t+String(a)]=r.wt;var o=n.getMax(t,a),l=n.getChartData(t,a,3);if(1==l.length)var u={wt:"None",date:l[0].date};else u=l[1];return console.log("lastItem",u),1==o.only1?(console.log("results preview lastone",{name:t,reps:a,todaysMax:e.todaysMaxs[t+String(a)],max:!1,last:0}),{name:t,reps:a,todaysMax:e.todaysMaxs[t+String(a)],max:0,last:0}):(-1e3>o||!o||o>1e3?e.maxList[t]="None":(e.maxList[t]=Math.abs(r.wt-Number(o.wt)),f[t]=r.wt&&r.wt-Number(o.wt)>0?0:1),-1e3>u||!u||u>1e3?e.lastList[t]="None":(e.lastList[t]=Math.abs(r.wt-Number(u.wt)),p[t]=r.wt&&r.wt-Number(u.wt)>0?0:1),console.log("results preview",{name:t,reps:a,todaysMax:e.todaysMaxs[t+String(a)],max:o,last:u}),{name:t,reps:a,todaysMax:e.todaysMaxs[t+String(a)],max:o,last:u})},e.changeNumber=function(t,a){if(console.log(t),e.editingNumber.id)if(1==e.editingNumber.id){if(a)return e.sets2[e.editingNumber.index].reps=t,void(e.editingShow={num:e.sets2[e.editingNumber.index].reps});m=Number(e.sets2[e.editingNumber.index].reps)+t,m>=0&&(e.sets2[e.editingNumber.index].reps=Number(e.sets2[e.editingNumber.index].reps)+t,e.editingShow={num:e.sets2[e.editingNumber.index].reps})}else if(2==e.editingNumber.id){if(a)return g=t,e.sets2[e.editingNumber.index].wt=t,void(e.editingShow={num:e.sets2[e.editingNumber.index].wt});g=Number(e.sets2[e.editingNumber.index].wt)+t,console.log(g),g>=0&&(e.sets2[e.editingNumber.index].wt=Number(e.sets2[e.editingNumber.index].wt)+t,e.editingShow={num:e.sets2[e.editingNumber.index].wt})}else if(3==e.editingNumber.id){var o=String(e.sets2[e.editingNumber.index].reps),i=Number(e.goalMapEdit[e.nameLift+o].wt);if(a)return h=t,void(e.goalMapEdit[e.nameLift+o]={wt:t});h=e.goalMapEdit[e.nameLift+o].wt+t,h>=0&&(e.goalMapEdit[e.nameLift+o]={wt:i+t})}},e.clearResults=function(){e.maxList={},e.lastList={},f={},p={},e.todaysMaxs={},e.lastClickedRep={}},e.onRelease=function(t,a){e.goalMapEdit[e.nameLift+t]={wt:e.rangeMap[a]}},e.selectNumber=function(t,a){1==a?(e.rangeFlipFlag=!0,e.editingShow={num:e.sets2[t].reps},e.editingNumber={index:t,id:a},e.wtSelectPress=t+String(a),console.log("main",e.wtSelectPress)):2==a&&(e.rangeFlipFlag=!1,e.editingShow={num:e.sets2[t].wt},e.editingNumber={index:t,id:a},e.wtSelectPress=t+String(a))},e.popAddSet=function(){var t=e.sets2.length-1;console.log(t),1==e.editingNumber.id?(e.rangeFlipFlag=!0,e.editingShow={num:e.sets2[t].reps},e.editingNumber.index=t,e.wtSelectPress=t+String(1)):(e.rangeFlipFlag=!0,e.editingShow={num:e.sets2[t].wt},e.editingNumber.index=t,e.wtSelectPress=t+String(2))},e.selectGoal=function(t){e.wtSelectPress=t+String(3),e.editingShow={num:e.goalMapEdit[e.nameLift+String(e.sets2[t].reps)]},e.editingNumber={index:t,id:3}},e.onReleaseNumber=function(){1==e.editingNumber.id?(m=e.editingShow.num,e.sets2[e.editingNumber.index].reps=e.editingShow.num):2==e.editingNumber.id&&(e.sets2[e.editingNumber.index].wt=e.editingShow.num,g=e.editingShow.num)},e.preset=function(t){var a=e.sets2.length-3;0>a&&(e.sets2.push(angular.copy(e.sets2[0])),a++,0>a&&e.sets2.push(angular.copy(e.sets2[0]))),1==t?angular.forEach(e.sets2,function(e,t){e.reps=5}):2==t?angular.forEach(e.sets2,function(e,t){e.reps=6}):3==t?angular.forEach(e.sets2,function(e,t){e.reps=8}):4==t&&angular.forEach(e.sets2,function(e,t){0==t&&(e.reps=5),1==t&&(e.reps=3),2==t&&(e.reps=1)}),e.sets2=_.first(e.sets2,3),e.liftCards[e.indexLift].sets=e.sets2},e.historyPop=function(t){if("Select Lift"!=e.liftCards[t].name&&(0!=e.liftCards[t].sets[0].reps||0!=e.liftCards[t].sets[0].wt)){e.histIndex=t;var a=[],o=e.liftCards[t].name;if(angular.forEach(e.liftCards[t].sets,function(e,t){a.push(e.reps)}),e.uniqueRepsHist=_.unique(a),e.maxList={},e.lastList={},angular.forEach(e.uniqueRepsHist,function(t,a){n.getMax(o,t).wt&&(e.maxList[t]=n.getMax(o,t).wt,e.lastList[t]=n.getChartData(o,t,3).reverse().slice(-1)[0].wt)}),0==e.maxList.length&&0==e.lastList.length){var i=s.show({title:"Lift History",subTitle:"No recorded numbers for selected lift and reps",scope:e,buttons:[{text:"<b >Done</b>",type:"button-dark",onTap:function(e){}}]});i.then(function(e){})}else{var i=s.show({templateUrl:"pop/pop-history.html",title:"Lift History",subTitle:"For selected lift and reps, this is your last weight lifted and max weight lifted",scope:e,buttons:[{text:"<b >Done</b>",type:"button-dark",onTap:function(e){}}]});i.then(function(e){})}}},r.fromTemplateUrl("pop/pop-liftnames.html",{scope:e}).then(function(t){e.popover=t}),e.namePopupSubmit=function(t){document.body.classList.add("platform-ios"),e.nameList=o.$storage.nameList,_.uniq(e.nameList,!1);var a=[];angular.forEach(e.nameList,function(t,o){""==t&&-1==a.indexOf("(No Name)")&&(e.nameList[o]="(No Name)"),a.push(e.nameList[o])}),e.nameList=_.uniq(a,!1),e.popover.show(t)},e.namePopupSelect=function(t){return"clear"==t?(e.nameFilter="Name",e.popover.hide(),void e.filter()):(e.workoutName.name=t,void e.popover.hide())},e.showConfirm=function(){var t=!1;if(angular.forEach(e.liftCards,function(e,a){"Select Lift"==e.name&&(t=!0)}),t){var a=s.confirm({title:'Remove or edit "Select Lift"'});a.then(function(e){})}return t?void 0:void e.openModal("none","none","none",5)},e.dateErrorPop=function(){s.show({title:"You already lifted today!",subTitle:"Slow down tiger! Only one workout per day! (otherwise our metrics get real messy). Delete today's lift from the calendar tab to re-enter",scope:e,buttons:[{text:"Cancel"},{text:"<b >Done</b>",type:"button-dark",onTap:function(e){}}]})},o.emailPop=function(){"heroku"==o.stateW&&winston.log("info",e.$storage.userId+", opened email");var t=s.show({title:"Like Gain Deck?",scope:o,templateUrl:"pop/pop-email.html",buttons:[{text:"<b>Done</b>",type:"button-dark",onTap:function(e){}}]});t.then(function(t){if("heroku"==o.stateW){if(o.email.email.length>3&&-1==o.email.email.indexOf("@")){winston.log("info",e.$storage.userId+" closed with no email");var a=Parse.Object.extend("Reddit"),i=new a;i.save({username:o.email.email,uid:o.$storage.userId}).then(function(e){})}else if(o.email.email.length>3){winston.log("info",e.$storage.userId+" closed with email"+o.email.email);var n=Parse.Object.extend("Email"),s=new n;s.save({address:o.email.email,uid:o.$storage.userId}).then(function(e){})}e.$broadcast("destroyEmail")}})},e.$on("destroyEmail",function(){u(function(){o.email.email=""},3e3)}),e.showInfo=function(){if("heroku"==o.stateW){winston.log("info",e.$storage.userId+", viewed home info");var t=new Date}var a=s.show({title:"New Workout",scope:e,templateUrl:"pop/pop-maininfo.html",buttons:[{text:"<b>Done</b>",type:"button-dark",onTap:function(e){}}]});a.then(function(a){if("heroku"==o.stateW){var i=new Date-t;winston.log("info",e.$storage.userId+", closed home info after"+i)}})},e.removeLiftRow=function(t){e.removeFlag&&e.liftCards.splice(t,1)},e.keyPressed=function(t,a){13==t.keyCode&&e.s()},e.clearLifts=function(){e.removeFlag&&(e.removeFlag=!1);var t=s.show({title:"Clear Lifts?",subTitle:"Today's data will be removed",scope:e,buttons:[{text:"Cancel"},{text:"<b>Clear</b>",type:"button-dark",onTap:function(t){n.clearLifts(),e.liftCards=e.$storage.todaysLifts,e.$storage.tabTitle="Lift",e.tabTitle="Lift",d.scrollTop()}}]});t.then(function(e){})},e.clearAll=function(){e.removeFlag&&(e.removeFlag=!1);var t=s.show({title:"Clear ALL APP DATA i love you?",subTitle:"All data you have inputted will be cleared from the app. Proceed? (just tap the icon to clear today only)",scope:e,buttons:[{text:"Cancel"},{text:"<b>Clear</b>",type:"button-dark",onTap:function(t){n.clearAll(),e.liftCards=e.$storage.todaysLifts,e.$storage.tabTitle="Lift",e.tabTitle="Lift",d.scrollTop()}}]});t.then(function(e){})},e.submitWeight=function(){e.liftCards[e.indexLift].sets=e.sets2,e.closeModal("lift",0,2)},e.toggleGroup=function(t){e.shownGroup=e.isGroupShown(t)?null:t},e.isGroupShown=function(t){return e.shownGroup===t},e.addSet=function(t){(0!=e.liftCards[t].sets[0].reps||0!=e.liftCards[t].sets[0].wt)&&n.addSet(t)},e.removeSet=function(e){n.removeSet(e)},e.updateGoals=function(){n.updateGoals(e.goalMapEdit),e.goalMap=e.$storage.goalsMap,e.closeModal("none",0,4)},e.outRemove=function(){e.removeFlag&&(e.removeFlag=!e.removeFlag)},e.popEditingNumber=function(t,a){t!=e.editingShow.num&&(a?e.changeNumber(t,a):e.changeNumber(t)),e.editingNumber.id=2,e.wtSelectPress=e.editingNumber.index+"2",e.editingShow={num:e.sets2[e.editingNumber.index].wt}},t.fromTemplateUrl("modals/nav-liftselector.html",{id:"1",scope:e,backdropClickToClose:!1,animation:"slide-in-up"}).then(function(t){e.modal=t}),t.fromTemplateUrl("modals/nav-weightselector.html",{id:"2",scope:e,backdropClickToClose:!0,animation:"slide-in-up"}).then(function(t){e.modal2=t}),t.fromTemplateUrl("modals/nav-results.html",{id:"3",scope:e,backdropClickToClose:!0,animation:"slide-in-up"}).then(function(t){e.modal3=t}),t.fromTemplateUrl("modals/nav-goals.html",{id:"4",scope:e,backdropClickToClose:!0,animation:"slide-in-up"}).then(function(t){e.modal4=t}),t.fromTemplateUrl("modals/nav-confirm.html",{id:"5",scope:e,backdropClickToClose:!0,animation:"slide-in-up"}).then(function(t){e.modal5=t}),e.openModal=function(t,a,o,i,n){if("Select Lift"!=t||2!=i){e.lightHeavyMap["Select Lift"]="heavy";var s=function(){e.modal.show()};if(1==i)e.blurFlag=!0,window.cordova&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),e.$storage.selectedLiftNames=[],angular.forEach(e.liftCards,function(t,a){t.name&&e.$storage.selectedLiftNames.push(t.name)}),u(s(),0),e.$storage.editingLift={name:t,index:a};else if(2==i)e.blurFlag=!0,e.nameLift=t,e.indexLift=a,angular.forEach(e.$storage.liftData,function(a,o){a.name==t&&(e.weightRack=a.weight)}),e.focusIndex=1,e.sets2=e.liftCards[a].sets,e.editingNumber=e.sets2[0].reps,e.editingShow={num:0},n?e.selectNumber(o,2):e.selectNumber(o,1),e.modal2.show();else if(3==i)e.blurFlag=!0,e.populateBodyWeightResults(),e.buildResultsObject(),e.modal3.show();else if(4==i){if("Select Lift"==e.liftCards[a].name||0==e.liftCards[a].sets[0].reps&&0==e.liftCards[a].sets[0].wt)return;e.blurFlag=!0,e.nameLift=t,e.indexLift=a,e.focusIndex=o,e.goalMapEdit=angular.copy(e.goalMap),e.sets2=_.uniq(e.liftCards[a].sets,!1,function(e){return Number(e.reps)}),e.selectGoal(0),angular.forEach(e.$storage.liftData,function(a,o){a.name==t&&(e.weightRack=a.weight)}),angular.forEach(e.sets2,function(t,a){e.goalMapEdit[e.nameLift+t.reps]?e.rangeMap[a]=e.goalMapEdit[e.nameLift+t.reps].wt:(e.goalMapEdit[e.nameLift+t.reps]={wt:0},e.rangeMap[a]=0)}),e.modal4.show()}else console.log("go",e.$storage.tabTitle,e.workoutName.name),"Lift"!=e.tabTitle&&(e.workoutName.name=angular.copy(e.$storage.tabTitle)),e.blurFlag=!0,e.modal5.show()}},e.$on("modal.hidden",function(){var t=w.newLift,a=(w.sets,w.id);1==a?(window.cordova,"no change"==t&&"Select Lift"==e.liftCards[e.$storage.editingLift.index].name&&(e.liftName="Select Lift"),"no change"!=t&&(e.liftCards[e.$storage.editingLift.index].name=t.name,e.$storage.lightHeavyMap[t.name]=t.weight),n.buildKgMap(),e.kgMap=e.$storage.kgMap,u(function(){e.$broadcast("reset-liftselect")},500)):2==a||(3==a?u(function(){e.clearResults()},3e3):4==a||1==t&&(n.checkDate(e.liftDate)?e.dateErrorPop():(n.saveLift(e.liftDate,e.liftCards,e.workoutName,e.bodyWeight,e.notes),e.resultsLifts=e.liftCards,e.liftCards=e.$storage.todaysLifts,e.uniqueSortReps(),e.openModal("","","","3"),e.workoutName.name="",e.notes.notes="",e.bodyWeight.wt="",i.go("tab.calendar"))))}),e.closeModal=function(t,a,o){w={newLift:t,sets:a,id:o},e.blurFlag=!1,1==o?e.modal.hide():2==o?e.modal2.hide():3==o?e.modal3.hide():4==o?e.modal4.hide():e.modal5.hide()},o.checkAndDoUpdate=function(t){console.log("Ionic Deploy: Checking for updates"),c.check().then(function(a){if(o.hasUpdate=a,"wifi"==t&&a){o.doUpdate();var i=s.show({title:"Update Available",subTitle:"Hot-updating your app, updates will appear next time the app is opened. (I only do this automatically over wifi!)",scope:e,buttons:[{text:"<b>Ok</b>",type:"button-dark"}]});i.then(function(e){})}else if(a){var n=s.show({title:"Update Available",subTitle:"Tap Ok to *hot-update* your app over cellular (Automatically, no redirect to app store. Alternatively wait for wifi)",scope:e,buttons:[{text:"Later"},{text:"<b>Ok</b>",type:"button-dark",onTap:function(t){e.$storage.updating=!0,o.doUpdate()}}]});n.then(function(e){})}},function(e){console.error("Ionic Deploy: Unable to check for updates",e)})},e.percentage="",o.doUpdate=function(){c.download().then(function(){c.extract().then(function(){e.$storage.updated=!0},function(e){},function(t){e.percentage=t})},function(e){alert(e)},function(t){e.percentage=t})}}]);